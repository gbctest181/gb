{% extends 'base.html.twig' %}

{% block title %}PROCES VERBAl{% endblock %}

{% block body %}
    {#_________Header___________#}
    <header class="jumbotron-fluid table-dark text-center">
        <div class="Logo"></div>
        <div class="title">
            <h1>PROCES VERBAL</h1>
        </div>
    </header>
    {#_________Info___________#}

    <div class="container">
        <div class="row" style="border: 1px solid #0a0a0a">
            <div class="row" >
                <div class="col">
                    <br>
                    <div class="col">
                        <U>Client</U> : <b>{{intervention.fkclient.raisonSociale}}</b>
                        <br>({{ intervention.fkclient.responsable }})
                    </div>
                    <div class="col">
                       <U>Adresse :</U><br>
                        {{ intervention.fkclient.adresse }}
                    </div>
                    <div class="col">
                        {{ intervention.fkclient.codepostal }} {{ intervention.fkclient.ville }}
                    </div>
                </div>
                <div class="col">
                    <br>
                    <div class="col">
                       <U>Telephone :</U> {{ intervention.fkclient.telephone }}
                    </div>
                    <div class="col">
                        <U>Mobile :</U>  {{ intervention.fkclient.mobile }}
                    </div>
                    <div class="col">
                       <U>Fax : </U>  {{ intervention.fkclient.fax }}
                    </div>
                    <div class="col">
                       <U>E-mail :</U>  {{ intervention.fkclient.email }}
                    </div>
                    <br>
                </div>
            </div>
            <div class="row" style="border-left: 1px solid #0a0a0a" >
                <div class="col">
                    <br>
                    <div class="col">
                        <U>Client :</U> {{ intervention.nom }}
                    </div>
                    <div class="col">
                        <U>Adresse du chantier :</U> <br>
                        {{ intervention.adresse }}
                    </div>
                    <div class="col">
                        {{ intervention.codepostal }} {{ intervention.ville }}
                    </div>
                    <div class="col"><!--Données récupérées de l'API-->
                        <U>Objet du marché :</U>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {#_________Proces verbal___________#}
    <div class="container">
        <br>
        <div class="clauses">
                <p>Le clients atteste, par le présent, que les matériels livrés et installés par GB CONCEPT :</p>
                <p> <span>&#128073;&#127996;</span>sont conformes aux caractéristiques indiquées dans les documents précisés en référence.</p>
                <p><span>&#128073;&#127996;</span> sont en bon état de fonctionnement.</p>
                <p><b><U>Rappel</U> : Les matériels fournis ce jour demeurent la propriété exclusive de l'entreprise GB CONCEPT jusqu'au paiement complet des matériels et prestations par le client.</b></p>
                <p> <b><U>Responsabilité :</U></b> A compter de ce jour, le client assure l'entière responsabilité des matériels, y compris l'ensemble des obligations d'assurance.</p>
        </div>
    </div><!--Clauses-->
    <div class="container">
        <div class="row">
            <div class="form-check ">
                <label for="observation"> Observations </label>
                <input class="form-check-label" type="checkbox" name="observation" id="observation"  >
            </div>
            <div class="form-group col-6" id="obsTech" style="display: none" >
                <label for="obs"></label>
                <textarea class="form-control" rows="3"  id="obs" placeholder="Observations  :"></textarea>
            </div>
        </div>
    </div><!--Observations-->
    <div class="container " style="border: 1px solid #0a0a0a">
        <div class="row">
            <div class="col"></div>
            <div class="col-3">
                <h4>GB CONCEPT</h4>
                Nom : nom du technicien{#{{ user.username }}#}
                <div class="Signature">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-12">
                                <canvas id="sig-canvas" width="250" height="100" style=" border: 2px dotted #CCCCCC; border-radius: 15px; cursor: crosshair; ">
                                </canvas>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button class="btn btn-primary" id="sig-submitBtn">Ok</button>
                                <button class="btn btn-default" id="sig-clearBtn">Effacer</button>
                            </div>
                        </div>
                    </div><!--SIGNATURE -->
                </div>
            </div>
            <div class="col"></div>
            <div class="col-3">
                Établi le {{ "now"|date("d/m/Y") }}
                <br>
                <button type="submit" class="btn btn-success ">Envoyer</button>
            </div>
            <div class="col"></div>
            <div class="col-3">
                <h4>LE CLIENT</h4>
                Nom : {{ intervention.nom }}
                <div class="container">
                    <div class="row">
                        <div class="col-md-12">
                            <canvas id="sig-canvas" width="250" height="100" style=" border: 2px dotted #CCCCCC; border-radius: 15px; cursor: crosshair; ">
                            </canvas>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button class="btn btn-primary" id="sig-submitBtn">Ok</button>
                            <button class="btn btn-default" id="sig-clearBtn">Effacer</button>
                        </div>
                    </div>
                </div><!--SIGNATURE -->
            </div>
        </div>

    </div><!--Accord-->
    <div class="retour">
        <button type="button" class="btn btn-danger"><a href="javascript:history.go(-1)">Retour</a></button>
    </div><!--Bouton retour-->
    {#_________Footer___________#}
    <footer class="jumbotron-fluid table-dark" id="footer">
        <div class="row">
            <div class="col-3">
                <div class="fblock-1"><a href="./"><img src="{{ asset('/public/images/logo.jpg') }}" alt="" ></a></div>
            </div>
            <div class="preffix_2 col-6">
                <div class="fblock-2">
                    <div class="fblock-2_s1">
                        <span class="fblock-2_s1_s1">GB CONCEPT</span>
                        &copy; <span id="copyright-year"></span>
                        | Mentions Légales</div>
                    <p>SARL GB CONCEPT-181, Rue de St Éxupéry-34130 MAUGUIO.</p>
                    <p>Tél: 04.20.30.28.28/ Fax: 04.67.82.75.38 Email: contact@gbconcept34.fr - RCS Montpellier 501 826 176</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        (function() {
            window.requestAnimFrame = (function(callback) {
                return window.requestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.oRequestAnimationFrame ||
                    window.msRequestAnimaitonFrame ||
                    function(callback) {
                        window.setTimeout(callback, 1000 / 60);
                    };
            })();

            const canvas = document.getElementById("sig-canvas");
            const ctx = canvas.getContext("2d");
            ctx.strokeStyle = "#222222";
            ctx.lineWidth = 1;

            let drawing = false;
            let mousePos = {
                x: 0,
                y: 0
            };
            let lastPos = mousePos;

            canvas.addEventListener("mousedown", function(e) {
                drawing = true;
                lastPos = getMousePos(canvas, e);
            }, false);

            canvas.addEventListener("mouseup", function(e) {
                drawing = false;
            }, false);

            canvas.addEventListener("mousemove", function(e) {
                mousePos = getMousePos(canvas, e);
            }, false);

            // Ajouter un support d'événement tactile pour mobile
            canvas.addEventListener("touchstart", function(e) {
            }, false);

            canvas.addEventListener("touchmove", function(e) {
                const touch = e.touches[0];
                const me = new MouseEvent("mousemove", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(me);
            }, false);

            canvas.addEventListener("touchstart", function(e) {
                mousePos = getTouchPos(canvas, e);
                const touch = e.touches[0];
                const me = new MouseEvent("mousedown", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(me);
            }, false);

            canvas.addEventListener("touchend", function(e) {
                const me = new MouseEvent("mouseup", {});
                canvas.dispatchEvent(me);
            }, false);

            function getMousePos(canvasDom, mouseEvent) {
                const rect = canvasDom.getBoundingClientRect();
                return {
                    x: mouseEvent.clientX - rect.left,
                    y: mouseEvent.clientY - rect.top
                }
            }

            function getTouchPos(canvasDom, touchEvent) {
                const rect = canvasDom.getBoundingClientRect();
                return {
                    x: touchEvent.touches[0].clientX - rect.left,
                    y: touchEvent.touches[0].clientY - rect.top
                }
            }

            function renderCanvas() {
                if (drawing) {
                    ctx.moveTo(lastPos.x, lastPos.y);
                    ctx.lineTo(mousePos.x, mousePos.y);
                    ctx.stroke();
                    lastPos = mousePos;
                }
            }

            // Empêcher le défilement lorsque vous touchez la zone de signature
            document.body.addEventListener("touchstart", function(e) {
                if (e.target === canvas) {
                    e.preventDefault();
                }
            }, false);
            document.body.addEventListener("touchend", function(e) {
                if (e.target === canvas) {
                    e.preventDefault();
                }
            }, false);
            document.body.addEventListener("touchmove", function(e) {
                if (e.target === canvas) {
                    e.preventDefault();
                }
            }, false);

            (function drawLoop() {
                requestAnimFrame(drawLoop);
                renderCanvas();
            })();

            function clearCanvas() {
                canvas.width = canvas.width;
            }

            // Configurer l'interface utilisateur
            const sigText = document.getElementById("sig-dataUrl");
            const sigImage = document.getElementById("sig-image");
            const clearBtn = document.getElementById("sig-clearBtn");
            const submitBtn = document.getElementById("sig-submitBtn");
            clearBtn.addEventListener("click", function(e) {
                clearCanvas();
                sigText.innerHTML = "Data URL for your signature will go here!";
                sigImage.setAttribute("src", "");
            }, false);
            submitBtn.addEventListener("click", function(e) {
                const dataUrl = canvas.toDataURL();
                //  sigText.innerHTML = dataUrl;           lien image pour la signature
                //  sigImage.setAttribute("src", dataUrl);
            }, false);
        })();
    </script><!--SIGNATURE -->
    <script>
        $('#observation').change(function () {
            {
                if (this.checked) {
                    document.querySelector('#obsTech').style.display = 'block';
                } else if(!this.checked) {
                    document.querySelector('#obsTech').style.display = 'none';
                }
            }
        })
    </script><!--Obsvervation-->
{% endblock %}
